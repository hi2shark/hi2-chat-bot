name: Build and Push Docker Image

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to use for the Docker image'
        required: false

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'

    - name: Install dependencies
      run: npm install

    - name: Determine version
      id: determine_version
      run: |
        if [ -z "${{ github.event.inputs.version }}" ]; then
          echo "VERSION=$(node -p 'require("./package.json").version')" >> $GITHUB_ENV
        else
          echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_ENV
        fi

    - name: Print version
      run: echo "Version is $VERSION"

    - name: Build Docker image
      run: |
        docker build -t ghcr.io/${{ github.repository }}:$VERSION .

    - name: Log in to GitHub Container Registry
      run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

    - name: Push Docker image
      run: |
        docker push ghcr.io/${{ github.repository }}:$VERSION
        docker tag ghcr.io/${{ github.repository }}:$VERSION ghcr.io/${{ github.repository }}:latest
        docker push ghcr.io/${{ github.repository }}:latest

    - name: Get previous tag
      id: get_previous_tag
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        git fetch --tags
        PREVIOUS_TAG=$(git tag -l "v*.*.*" --sort=-v:refname | head -n 2 | tail -n 1)
        echo "PREVIOUS_TAG=$PREVIOUS_TAG" >> $GITHUB_ENV
        echo "Previous tag: $PREVIOUS_TAG"
        echo "Current tag: ${{ github.ref_name }}"

    - name: Generate changelog
      id: generate_changelog
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        # Get commits between tags
        if [ -z "$PREVIOUS_TAG" ]; then
          COMMITS=$(git log ${{ github.ref_name }} --pretty=format:"%h|%s")
        else
          COMMITS=$(git log $PREVIOUS_TAG..${{ github.ref_name }} --pretty=format:"%h|%s")
        fi
        
        # Initialize categories
        FEAT=""
        FIX=""
        DOCS=""
        REFACTOR=""
        PERF=""
        TEST=""
        CHORE=""
        OTHER=""
        
        # Parse commits and categorize
        while IFS='|' read -r hash message; do
          if [[ $message =~ ^feat[:ï¼š] ]]; then
            FEAT="${FEAT}- ${message#*[:ï¼š] } (\`$hash\`)\n"
          elif [[ $message =~ ^fix[:ï¼š] ]]; then
            FIX="${FIX}- ${message#*[:ï¼š] } (\`$hash\`)\n"
          elif [[ $message =~ ^docs[:ï¼š] ]]; then
            DOCS="${DOCS}- ${message#*[:ï¼š] } (\`$hash\`)\n"
          elif [[ $message =~ ^refactor[:ï¼š] ]]; then
            REFACTOR="${REFACTOR}- ${message#*[:ï¼š] } (\`$hash\`)\n"
          elif [[ $message =~ ^perf[:ï¼š] ]]; then
            PERF="${PERF}- ${message#*[:ï¼š] } (\`$hash\`)\n"
          elif [[ $message =~ ^test[:ï¼š] ]]; then
            TEST="${TEST}- ${message#*[:ï¼š] } (\`$hash\`)\n"
          elif [[ $message =~ ^chore[:ï¼š] ]]; then
            CHORE="${CHORE}- ${message#*[:ï¼š] } (\`$hash\`)\n"
          else
            OTHER="${OTHER}- ${message} (\`$hash\`)\n"
          fi
        done <<< "$COMMITS"
        
        # Build changelog
        CHANGELOG=""
        
        if [ -n "$FEAT" ]; then
          CHANGELOG="${CHANGELOG}### âœ¨ æ–°åŠŸèƒ½\n\n${FEAT}\n"
        fi
        
        if [ -n "$FIX" ]; then
          CHANGELOG="${CHANGELOG}### ğŸ› é—®é¢˜ä¿®å¤\n\n${FIX}\n"
        fi
        
        if [ -n "$PERF" ]; then
          CHANGELOG="${CHANGELOG}### âš¡ æ€§èƒ½ä¼˜åŒ–\n\n${PERF}\n"
        fi
        
        if [ -n "$REFACTOR" ]; then
          CHANGELOG="${CHANGELOG}### â™»ï¸ ä»£ç é‡æ„\n\n${REFACTOR}\n"
        fi
        
        if [ -n "$DOCS" ]; then
          CHANGELOG="${CHANGELOG}### ğŸ“ æ–‡æ¡£æ›´æ–°\n\n${DOCS}\n"
        fi
        
        if [ -n "$TEST" ]; then
          CHANGELOG="${CHANGELOG}### ğŸ§ª æµ‹è¯•ç›¸å…³\n\n${TEST}\n"
        fi
        
        if [ -n "$CHORE" ]; then
          CHANGELOG="${CHANGELOG}### ğŸ”§ å…¶ä»–æ›´æ”¹\n\n${CHORE}\n"
        fi
        
        if [ -n "$OTHER" ]; then
          CHANGELOG="${CHANGELOG}### ğŸ“¦ å…¶ä»–æäº¤\n\n${OTHER}\n"
        fi
        
        # Save to file to avoid issues with multiline in env
        echo -e "$CHANGELOG" > changelog.md
        
        # Also save to env using delimiter
        {
          echo 'CHANGELOG<<EOF'
          echo -e "$CHANGELOG"
          echo 'EOF'
        } >> $GITHUB_ENV

    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        tag_name: ${{ github.ref_name }}
        name: Release ${{ env.VERSION }}
        body: |
          ## ğŸ“‹ æ›´æ–°å†…å®¹
          
          ${{ env.CHANGELOG }}
          
          ## ğŸ³ Docker é•œåƒä¿¡æ¯
          - é•œåƒç‰ˆæœ¬: `${{ env.VERSION }}`
          - é•œåƒåœ°å€: `ghcr.io/${{ github.repository }}:${{ env.VERSION }}`
          
          ## ğŸ“¦ ä½¿ç”¨æ–¹æ³•
          ```bash
          docker pull ghcr.io/${{ github.repository }}:${{ env.VERSION }}
          ```
        draft: true
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
